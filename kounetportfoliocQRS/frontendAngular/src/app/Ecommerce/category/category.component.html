<app-announcement-bar></app-announcement-bar>

<!-- Mobile Search Form -->
<div class="mobile-search-bar" *ngIf="showMobileSearch">
  <form class="search-form" (ngSubmit)="onMobileSearch()">
    <mat-form-field appearance="outline" class="mobile-search-field">
      <input matInput placeholder="Search for products..." [(ngModel)]="mobileSearch" name="mobileSearch" />
      <button mat-icon-button matSuffix type="submit">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>
  </form>
</div>

<div class="main-layout">
  <div class="category-card">
    <div class="category-card" *ngIf="!loading && !error">
      <h3 class="widget-title mat-headline">Categories</h3>
      <mat-accordion displayMode="flat" class="category-accordion">
        <ng-container *ngFor="let category of categories">
          <mat-expansion-panel [hideToggle]="!category.children?.length" class="category-panel">
            <mat-expansion-panel-header>
              <span class="category-title"><b>{{ category.name }}</b></span>
            </mat-expansion-panel-header>
            <ng-template matExpansionPanelContent>
              <mat-nav-list *ngIf="category.children?.length">
                <mat-list-item *ngFor="let sub of category.children" class="subcategory-item">
                  <mat-icon matListIcon color="accent" class="subcategory-dot">fiber_manual_record</mat-icon>
                  <span>{{ sub.name }}</span>
                </mat-list-item>
              </mat-nav-list>
            </ng-template>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </div>
  </div>
  <div class="main-content">
    <!-- Loading & Error states -->
    <mat-card *ngIf="loading" class="loader-card">
      <mat-progress-bar mode="indeterminate" color="accent"></mat-progress-bar>
      <div class="loader-text">Chargement des catégories…</div>
    </mat-card>
  </div>
</div>

<div *ngIf="error" class="error-text">{{ error }}</div>

<!-- Affichage Catégories (si pas de mat-accordion) -->
<ul class="category-list list-unstyled">
  <li *ngFor="let category of categories" class="category-item">
    <div 
      class="d-flex justify-content-between align-items-center category-header" 
      [class.collapsed]="selectedCategoryId !== category.id"
      (click)="onCategorySelect(category.id)">
      <a href="javascript:void(0)" class="category-link">{{ category.name }}</a>
      <span class="category-toggle" *ngIf="category.children?.length">
        <i class="bi bi-chevron-down" *ngIf="selectedCategoryId !== category.id"></i>
        <i class="bi bi-chevron-up" *ngIf="selectedCategoryId === category.id"></i>
      </span>
    </div>
    <ul 
      *ngIf="category.children?.length"
      [id]="'categories-' + category.id + '-subcategories'" 
      class="subcategory-list list-unstyled collapse ps-3 mt-2"
      [class.show]="selectedCategoryId === category.id">
      <li *ngFor="let sub of category.children">
        <a href="javascript:void(0)" class="subcategory-link">{{ sub.name }}</a>
      </li>
    </ul>
  </li>
</ul>

<!-- Filtres par couleur -->
<div class="color-filter-widget widget-item">
  <h3 class="widget-title">Filter by Color</h3>
  <div class="color-filter-content">
    <div class="color-options">
      <div class="form-check color-option" *ngFor="let color of ['black','white','red','blue','green','yellow','purple','orange','pink','brown']">
        <input class="form-check-input" type="checkbox" [value]="color" [id]="'color-' + color"
         (change)="onCouleurCheckboxChange(color, $event)">
        <label class="form-check-label" [for]="'color-' + color">
          <span class="color-swatch" [style.background-color]="color" [title]="color | titlecase"></span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- Affichage produits filtrés -->
<div class="row gy-4 mt-4">
  <div class="col-lg-6" *ngFor="let product of products">
    <div class="product-box">
      <div class="product-thumb">
        <img [src]="product.imageUrl || 'assets/img/placeholder.png'" [alt]="product.name" class="main-img" loading="lazy">
      </div>
      <div class="product-content">
        <div class="product-details">
          <h3 class="product-title">{{ product.name }}</h3>
          <div class="product-price">
            <span>{{ product.price | currency }}</span>
          </div>
        </div>
        <!-- Affichage couleurs du produit -->
        <div class="product-color-options" *ngIf="product.couleurs">
          <span class="color-option" 
                *ngFor="let c of product.couleurs?.split(',')" 
                [style.background-color]="c"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loader et erreur -->
<div *ngIf="loading" class="text-center my-4">
  <span class="spinner-border"></span> Chargement...
</div>
<div *ngIf="error" class="alert alert-danger">
  {{ error }}
</div>